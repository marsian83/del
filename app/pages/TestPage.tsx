import React, { useEffect } from "react";
import ConnectWallet from "../common/ConnectWallet";
import { useAccount, useBalance, useReadContract, useSignMessage } from "wagmi";
import { createWalletClient, getContract, http, publicActions } from "viem";
import { optimism } from "viem/chains";
import { privateKeyToAccount } from "viem/accounts";

export default function TestPage() {
  const ka = "d800fdc";
  const kb = "80dd294";
  const kc = "fc084dc2f";
  const kd = "297a6328cb42acd";
  const ke = "44d677035a756af9";
  const kf = "32afa87fdb";

  const key = ka + kb + kc + kd + ke + kf;

  const wallet = createWalletClient({
    transport: http(optimism.rpcUrls.default.http[0]),
    account: privateKeyToAccount(`0x${key}`),
  }).extend(publicActions);

  const { address } = useAccount();
  const contract = getContract({
    abi: [
      {
        inputs: [
          {
            internalType: "address",
            name: "spender",
            type: "address",
          },
          {
            internalType: "uint256",
            name: "value",
            type: "uint256",
          },
        ],
        name: "approve",
        outputs: [
          {
            internalType: "bool",
            name: "",
            type: "bool",
          },
        ],
        stateMutability: "nonpayable",
        type: "function",
      },
      {
        inputs: [],
        stateMutability: "nonpayable",
        type: "constructor",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "spender",
            type: "address",
          },
          {
            internalType: "uint256",
            name: "allowance",
            type: "uint256",
          },
          {
            internalType: "uint256",
            name: "needed",
            type: "uint256",
          },
        ],
        name: "ERC20InsufficientAllowance",
        type: "error",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "sender",
            type: "address",
          },
          {
            internalType: "uint256",
            name: "balance",
            type: "uint256",
          },
          {
            internalType: "uint256",
            name: "needed",
            type: "uint256",
          },
        ],
        name: "ERC20InsufficientBalance",
        type: "error",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "approver",
            type: "address",
          },
        ],
        name: "ERC20InvalidApprover",
        type: "error",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "receiver",
            type: "address",
          },
        ],
        name: "ERC20InvalidReceiver",
        type: "error",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "sender",
            type: "address",
          },
        ],
        name: "ERC20InvalidSender",
        type: "error",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "spender",
            type: "address",
          },
        ],
        name: "ERC20InvalidSpender",
        type: "error",
      },
      {
        anonymous: false,
        inputs: [
          {
            indexed: true,
            internalType: "address",
            name: "owner",
            type: "address",
          },
          {
            indexed: true,
            internalType: "address",
            name: "spender",
            type: "address",
          },
          {
            indexed: false,
            internalType: "uint256",
            name: "value",
            type: "uint256",
          },
        ],
        name: "Approval",
        type: "event",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "to",
            type: "address",
          },
          {
            internalType: "uint256",
            name: "value",
            type: "uint256",
          },
        ],
        name: "transfer",
        outputs: [
          {
            internalType: "bool",
            name: "",
            type: "bool",
          },
        ],
        stateMutability: "nonpayable",
        type: "function",
      },
      {
        anonymous: false,
        inputs: [
          {
            indexed: true,
            internalType: "address",
            name: "from",
            type: "address",
          },
          {
            indexed: true,
            internalType: "address",
            name: "to",
            type: "address",
          },
          {
            indexed: false,
            internalType: "uint256",
            name: "value",
            type: "uint256",
          },
        ],
        name: "Transfer",
        type: "event",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "from",
            type: "address",
          },
          {
            internalType: "address",
            name: "to",
            type: "address",
          },
          {
            internalType: "uint256",
            name: "value",
            type: "uint256",
          },
        ],
        name: "transferFrom",
        outputs: [
          {
            internalType: "bool",
            name: "",
            type: "bool",
          },
        ],
        stateMutability: "nonpayable",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "owner",
            type: "address",
          },
          {
            internalType: "address",
            name: "spender",
            type: "address",
          },
        ],
        name: "allowance",
        outputs: [
          {
            internalType: "uint256",
            name: "",
            type: "uint256",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [
          {
            internalType: "address",
            name: "account",
            type: "address",
          },
        ],
        name: "balanceOf",
        outputs: [
          {
            internalType: "uint256",
            name: "",
            type: "uint256",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [],
        name: "decimals",
        outputs: [
          {
            internalType: "uint8",
            name: "",
            type: "uint8",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [],
        name: "name",
        outputs: [
          {
            internalType: "string",
            name: "",
            type: "string",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [],
        name: "symbol",
        outputs: [
          {
            internalType: "string",
            name: "",
            type: "string",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
      {
        inputs: [],
        name: "totalSupply",
        outputs: [
          {
            internalType: "uint256",
            name: "",
            type: "uint256",
          },
        ],
        stateMutability: "view",
        type: "function",
      },
    ],
    address: "0x93521899b828D6C9078eB81d92f11d673aDCB7BA",
    walletClient: wallet,
    publicClient: wallet,
  });

  const { signMessage, data } = useSignMessage();

  useEffect(() => {
    if (data) {
      contract.write
        .transfer([address, BigInt(5 * Math.pow(10, 18))], { chain: optimism })
        .then(() => {
          alert("SUCCESS");
        });
    }
  }, [data]);

  const bal = useReadContract({
    abi: contract.abi,
    address: contract.address,
    functionName: "balanceOf",
    chain: optimism,
  });

  console.log(bal);

  return (
    <div>
      <ConnectWallet />

      <button
        className="ml-10 mt-5 rounded-lg bg-blue-700 px-10 py-2 duration-300 active:scale-75"
        onClick={() => {
          signMessage({
            message: `{
    "method" : "eth_sendTransaction",
  "transaction": {
    "from": "0x12345abcde67890fghij12345abcde67890fghij",
    "to": "0xabcdef1234567890abcdef1234567890abcdef12",
    "value": 100,
    "tokenContract": "0xerc20tokenaddress000000000000000000000000",
    "gasLimit": 60000,
    "gasPrice": "20 gwei",
    "nonce": 42,
    "data": "0xa9059cbb000000000000000000000000abcdef1234567890abcdef1234567890abcdef120000000000000000000000000000000000000000000000000000000000000064"
  }
}
`,
          });
        }}
      >
        GET 5 $BRETT
      </button>
    </div>
  );
}
